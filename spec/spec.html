<!DOCTYPE html>
<title>Depict spectrogram of an audio file</title>
<link href='http://fonts.googleapis.com/css?family=Bubblegum+Sans|VT323' rel='stylesheet' type='text/css'>
<script src=UFXgl.js></script>
<script src=UFXmaximize.js></script>
<script src=UFXdraw.js></script>
<script src=UFXresource.js></script>
<script src=UFXmouse.js></script>
<body>
</body>
<style>
body {
	background: black;
}
</style>
<script src=info.js></script>
<script src=spec.js></script>
<script>
var catcher = new FileCatcher()
var audiopter = new Audiopter()
var spectropter = null
catcher.oncatch = function (file) {
	audiopter.upload(file)
}
var pcanvas = null
audiopter.onready = function () {
	spectropter = new Spectropter(audiopter)
	audiopter.play()
}
UFX.mouse.init(canvas2d)
function think() {
	raftoken = requestAnimationFrame(think)
	var mstate = UFX.mouse.state()
	info.think()
	UFX.draw("c0")
	catcher.draw()
	if (pcanvas) UFX.draw("drawimage0", pcanvas)
	if (spectropter) {
		spectropter.killtime(0.05)
		if (audiopter.source) {
			var b = 20
			var x = b, w = Math.round(canvas2d.width * 0.5) - 2 * b
			var h = Math.round(canvas2d.height * 0.7) - 2 * b, y = b
			UFX.draw("fs #007 fr", x - 2, y - 2, w + 4, h + 4)
			spectropter.fillRectZoom(x, y, w, h, audiopter.currentTime(), 0.15 * w)
			function drawhline(f, color, text) {
				if (f <= 0 || f >= 1) return
				var py = y + h - h * f
				UFX.draw("b m", x, py, "l", x+w, py, "ss", color, "lw 1 s")
				if (text) {
					UFX.draw("[ t", x + w - 2, py, "fs", color, "tab right bottom",
						"fs", color, "ft0", text, "]")
				}
			}
			UFX.draw("font 18px~'VT323'")
			for (var octave = 0 ; octave < 10 ; ++octave) {
				var hA = -48 + 12 * octave
				drawhline((hA - hmin) / (hmax - hmin), "#00F", "A" + octave)
				var hDs = -54 + 12 * octave
				drawhline((hDs - hmin) / (hmax - hmin), "#007", "D#" + octave)
			}
			UFX.draw("b m", x+w/2, y, "l", x+w/2, y+h, "ss cyan lw 1 s")
		}

		var b = 20
		var x = b, w = canvas2d.width - 2 * b
		var h = Math.round(canvas2d.height * 0.2), y = canvas2d.height - h - b
		UFX.draw("fs #007 fr", x - 2, y - 2, w + 4, h + 4)
		spectropter.fillRect(x, y, w, h)
		function drawline(f, color, text) {
			var px = x + w * f
			UFX.draw("b m", px, y, "l", px, y+h, "ss", color, "lw 1 s")
			if (text) {
				UFX.draw("[ t", px, y - 4, "fs", color, "tab center bottom",
					"fs", color, "ft0", text, "]")
			}
		}
		UFX.draw("font 18px~'VT323'")
		var t = audiopter.t
		var dt = [0.1, 0.2, 0.5, 1, 2, 5, 10, 20, 30, 60].filter(function (dt) {
			return w * dt / t > 50
		})[0]
		for (var a = 1 ; a * dt < t ; ++a) {
			drawline(a * dt / t, "#007", (a * dt).toFixed(dt < 1 ? 1 : 0) + "s")
		}
		if (audiopter.source && audiopter.currentFraction() < 1) {
			drawline(audiopter.currentFraction(), "cyan")
		}
		if (mstate.left.down) {
			var mx = mstate.pos[0], my = mstate.pos[1]
			if (x <= mx && mx <= x + w && y <= my && my <= y + h) {
				audiopter.play(audiopter.t * (mx - x) / w)
			}
		}
	}
}

UFX.resource.onload = function () {
	think()
}
UFX.resource.load({
	shaders: "spec.shader",
})


</script>

